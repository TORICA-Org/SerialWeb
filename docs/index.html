<!DOCTYPE html>
<html lang='ja'>

<head>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width,initial-scale=1' />
  <title>SerialWeb</title>
</head>
<style>
  :root {
    font-family: sans-serif;
    padding: 20px;
  }
  h1 {
    font-size: xx-large;
    text-align: center;
  }
  svg {
    display: block;
    margin: 20px auto;
  }
  #tabBar {
    max-width: 800px;
    display: flex;
    justify-content: left;
    margin: 0 auto;
    gap: 5px;
    user-select: none; /* 選択を禁止する */
  }
  #tabBar div {
    padding: 10px 20px;
    font-size: large;
    font-weight: bold;
    cursor: pointer;
    border-top: 3px solid silver;
    border-left: 3px solid silver;
    border-right: 3px solid silver;
    border-radius: 10px 10px 0 0;
    background-color: white;
    position: relative;
    z-index: 10;
  }
  #tabBar div:active {
    background-color: #DDD;
  }
  .content {
    position: relative;
    box-sizing: border-box;
    max-width: 800px;
    margin: -3px auto 20px auto;
    padding: 20px;
    border: 3px solid silver;
    border-radius: 0 10px 10px 10px;
    z-index: 0;
  }
  #dashboardWrapper {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 5px;
  }
  #dashboardWrapper div {
    flex-basis: 25%;
  }
  #logWindow {
    font-family: monospace;
    margin: 0 0 10px 0;
    padding: 10px;
    border: 1px solid black;
    height: 200px;
    overflow-y: scroll;
    background-color: #f9f9f9;
    border: slategray 1px solid;
    height: 400px;
  }
  #logWindow div {
    padding: 3px 5px;
  }
  #logWindow div:nth-child(odd) {
    background-color: #e9e9e9;
  }
  #logForm {
    margin-top: 7px;
    display: flex;
    gap: 5px;
  }
  #logInput {
    padding: 6px;
    font-family: monospace;
    border: slategray 1px solid;
    border-radius: 5px;
    flex: 1;
  }
  .checkboxWrapper {
    display: inline-block;
    cursor: pointer;
  }
  button {
    padding: 6px 12px;
    font-weight: bold;
    cursor: pointer;
    border: slategray 1px solid;
    border-radius: 5px;
  }
  .pushable-button {
    color: black;
    transition: all 0.1s; /* 状態変化を滑らかにする */
  }
  .active-button {
    background-color: darkblue; /* クリック中は少し暗い色に */
    color: white;
  }
</style>

<body>
  <h1>SerialWeb</h1>
  <div id='tabBar'>
    <div id='dashboardTab' onclick='changeTab(this.id)'>Dashboard</div>
    <div id='logTab' onclick='changeTab(this.id)'>Log</div>
  </div>
  <div id='dashboardWrapper' class='content'></div>
  <div id='logWrapper' class='content'>
    <div id='logWindow'></div>
    <button id='pauseButton' class='pushable-button'>Pause</button>
    <button id='clearButton'>Clear</button>
    <div class = 'checkboxWrapper'>
      <input type='checkbox' id='autoScroll' checked></input><label for='autoScroll'> Auto Scroll</label>
    </div>
    <div class = 'checkboxWrapper'>
      <input type='checkbox' id='logTimestamps' checked></input><label for='logTimestamps'> Show Timestamps</label><br>
    </div>
    <form id='logForm'>
      <input type='text' id='logInput' placeholder='Type a message...' />
      <button id='logSendButton'>Send</button>
    </form>
  </div>

  <script src='demo.js' type='text/javascript'></script>
  <script type='text/javascript'>
    // グローバル変数として websocket を保持
    let websocket;

    function initWebSocket() { // WebSocket接続の初期化（または再接続）
      addLog('Attempting to connect WebSocket...');
      websocket = new WebSocket(`ws://${location.hostname}/ws`);// ポート80はHTTPのデフォルトなので、:80 は省略可能

      websocket.onopen = () => { // 接続成功時の処理
        addLog('WebSocket connected');
      };

      websocket.onclose = () => { // 切断時の処理
        addLog('WebSocket disconnected. Reconnecting in 2 seconds...');
        setTimeout(initWebSocket, 2000); // 2秒後に再接続を試みる
      };

      websocket.onmessage = (event) => { // メッセージ受信時の処理
        addLog(`Received: ${event.data}`);
        // jsonデータのパース
        const data = JSON.parse(event.data);
        updateDashbordItem(data.index, data.label, data.value);
      };

      websocket.onerror = (event) => {
        console.error('WebSocket Error: ', event);
        // エラー時も onclose が呼ばれることが多いので、再接続は onclose に任せる
      };
    }

    // ページが読み込まれたら、最初の接続を開始する
    window.addEventListener('load', initWebSocket);

    // タブの切り替え処理
    function changeTab(selectedTabId) {
      //console.log(`Changing to tab: ${selectedTab.id}`);
      const dashboardWrapper = document.getElementById('dashboardWrapper'); // ダッシュボード要素を取得
      //console.log(dashboardWrapper);
      const logWrapper = document.getElementById('logWrapper'); // ログラッパー要素を取得
      //console.log(logWrapper);
      const tabs = document.getElementById('tabBar').children; // タブバーの子要素を取得
      for (let i = 0; i < tabs.length; i++) {
        tabs[i].style.zIndex = 0; // すべてのタブの zIndex をリセット
      }
      document.getElementById(selectedTabId).style.zIndex = 10; // 選択されたタブの zIndex を上げる
      if (selectedTabId === 'dashboardTab') {
        dashboardWrapper.style.display = 'block'; // ダッシュボードを表示
        logWrapper.style.display = 'none'; // ログラッパーを非表示
      } else if (selectedTabId === 'logTab') {
        dashboardWrapper.style.display = 'none'; // ダッシュボードを非表示
        logWrapper.style.display = 'block'; // ログラッパーを表示
      }
    }
    changeTab('dashboardTab'); // 初期表示はダッシュボードタブ

    // ログ一時停止ボタンのイベントリスナー設定
    let logPaused = false; // ログ一時停止状態を示すフラグ
    const pauseButton = document.getElementById('pauseButton');
    pauseButton.addEventListener('click', () => { // 一時停止ボタンのクリックイベントリスナーを設定
      const pauseLog = document.getElementById('pauseLog');
      logPaused = !logPaused; // ログ一時停止状態をトグル
      if (logPaused) {
        pauseButton.classList.remove('pushable-button');
        pauseButton.classList.add('active-button');
      } else {
        pauseButton.classList.add('pushable-button');
        pauseButton.classList.remove('active-button');
      }
    });

    // ログ消去ボタンのイベントリスナー設定
    const clearButton = document.getElementById('clearButton');
    clearButton.addEventListener('click', () => { // クリアボタンのクリックイベントリスナーを設定
      const logWindow = document.getElementById('logWindow'); // ログウィンドウ要素を取得
      logWindow.innerHTML = ''; // ログウィンドウの内容をクリア
    });

    // オートスクロールのチェックボックスのイベントリスナーを設定
    const autoScroll = document.getElementById('autoScroll');
    autoScroll.addEventListener('change', () => { // オートスクロールのチェックボックスが変更されたときの処理
      const logWindow = document.getElementById('logWindow'); // ログウィンドウ要素を取得
      if (autoScroll.checked) {
        logWindow.scrollTop = logWindow.scrollHeight; // オートスクロールが有効なら、スクロール位置を最下部に設定
      }
    });

    // ログを表示するヘルパー関数
    const MAX_LOG_ENTRIES = 500;
    function addLog(message) {
      if (logPaused) return; // ログ一時停止が有効なら、何もしない
      const logWindow = document.getElementById('logWindow'); // ログウィンドウ要素を取得
      const logTimestampsChecked = document.getElementById('logTimestamps').checked; // タイムスタンプ表示のチェック状態を取得
      const now = new Date();
      const timestamp = logTimestampsChecked 
    ? `[${now.toLocaleTimeString()}:${now.getMilliseconds().toString().padStart(3, '0')}] ` 
    : '';
      const logEntry = document.createElement('div'); // 新しいdiv要素を作成
      logEntry.textContent = timestamp + message; // ログメッセージを設定
      logWindow.appendChild(logEntry); // ログウィンドウにログエントリを追加
      if (autoScroll.checked) {
        logWindow.scrollTop = logWindow.scrollHeight; // オートスクロールが有効なら、スクロール位置を最下部に設定
      }
      while (logWindow.children.length > MAX_LOG_ENTRIES) {
        logWindow.removeChild(logWindow.firstChild);
      }
    }

    // ダッシュボードアイテムを更新する関数
    function updateDashbordItem(index, label, value) {
      const dashboardWrapper = document.getElementById('dashboardWrapper'); // ダッシュボード要素を取得
      const itemDiv = document.createElement('div'); // 新しいdiv要素を作成
      itemDiv.style.border = '1px solid black'; // 枠線を設定
      itemDiv.style.padding = '10px'; // パディングを設定
      itemDiv.style.minWidth = '100px'; // 最小幅を設定
      itemDiv.style.textAlign = 'center'; // テキストを中央揃えに設定

      const labelDiv = document.createElement('div'); // ラベル用のdiv要素を作成
      labelDiv.textContent = label; // ラベルテキストを設定
      labelDiv.style.fontWeight = 'bold'; // ラベルを太字に設定

      const valueDiv = document.createElement('div'); // 値用のdiv要素を作成
      valueDiv.textContent = value; // 値テキストを設定
      valueDiv.style.fontSize = '24px'; // 値のフォントサイズを大きく設定

      itemDiv.appendChild(labelDiv); // ラベルdivをアイテムdivに追加
      itemDiv.appendChild(valueDiv); // 値divをアイテムdivに追加
      dashboardWrapper.appendChild(itemDiv); // アイテムdivをダッシュボードに追加
    }
    
    // ログ送信フォームのイベントリスナー設定
    const logForm = document.getElementById('logForm');
    logForm.addEventListener('submit', function(event) {
      event.preventDefault(); // フォームのデフォルトの送信動作を防止
      const logInput = document.getElementById('logInput'); // ログ入力要素を取得
      const message = logInput.value.trim(); // 入力値を取得してトリム
      if (message !== '') {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
          websocket.send(message); // WebSocketが接続されていればメッセージを送信
          addLog(`Sent: ${message}`); // 送信ログを追加
          logInput.value = ''; // 入力フィールドをクリア
        } else {
          addLog('WebSocket is not connected. Cannot send message.'); // 接続されていない場合のログを追加
        }
      }
    });

    
    function testlog() {
      for (let i = 0; i < 5; i++) {
        addLog(`Test log message ${i + 1}`);

      }
    }

    // setInterval(() => {
    //   testlog();
    // }, 1000);
  </script>
</body>
</html>
