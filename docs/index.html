<!DOCTYPE html>
<html lang='ja'>

<head>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width,initial-scale=1' />
  <title>SerialWeb</title>
</head>
<style>
  :root {
    font-family: sans-serif;
    padding: 20px;
  }
  h1 {
    font-size: xx-large;
    text-align: center;
  }
  svg {
    display: block;
    margin: 20px auto;
  }
  #tabBar {
    max-width: 800px;
    display: flex;
    justify-content: left;
    margin: 0 auto;
    gap: 5px;
    user-select: none; /* 選択を禁止する */
  }
  #tabBar div {
    padding: 10px 20px;
    font-size: large;
    font-weight: bold;
    cursor: pointer;
    border-top: 3px solid silver;
    border-left: 3px solid silver;
    border-right: 3px solid silver;
    border-radius: 10px 10px 0 0;
    background-color: white;
    position: relative;
    z-index: 50;
  }
  #tabBar div:active {
    background-color: #DDD;
  }
  #tabBar .active {
    z-index: 100;
  }
  .content {
    position: relative;
    box-sizing: border-box;
    max-width: 800px;
    margin: -3px auto 20px auto;
    padding: 20px;
    border: 3px solid silver;
    border-radius: 0 10px 10px 10px;
    z-index: 50;
  }
  #dashboardWrapper {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 7px;
  }
  #dashboardWrapper > div {
    display: flex;
    gap: 5px;
    border: gray solid 1px;
    border-radius: 5px;
    padding: 5px;
    min-width: 100px;
    flex-grow: 1;
  }
  #dashboardWrapper > div.update {
    animation-duration: 200ms;
    animation-name: update;
  }
  @keyframes update {
    from {
      box-shadow: 0px 0px 2px 2px gold;
    }
    to {
      box-shadow: none;
    }
  }
  #dashboardWrapper div .label {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    flex-basis: 50%;
    text-align: center;
    background-color: #EEE;
    border-radius: 5px;
    padding: 10px 5px;
    font-weight: bold;
  }
  #dashboardWrapper div .value {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    flex-basis: 50%;
    text-align: center;
    padding: 10px 5px;
  }
  #logWindow {
    display: flex;
    flex-direction: column;
    font-family: monospace;
    margin: 0;
    border: 1px solid gray;
    height: 200px;
    overflow: scroll;
    white-space: pre;
    background-color: #f9f9f9;
    border: slategray 1px solid;
    height: 400px;
    padding: 3px;
  }
  #logWindow > div {
      display: inline-block;
      padding: 5px;
      border-bottom: 1px dotted gray;
  }

  #statusWrapper {
    background-color: #EEE;
    border: gray solid 1px;
    border-radius: 0 0 5px 5px;
    margin: -1px 0 7px 0;
    padding: 5px;
}
  #logForm {
    margin-top: 7px;
    display: flex;
    gap: 5px;
  }
  #logInput {
    padding: 6px;
    font-family: monospace;
    border: slategray 1px solid;
    border-radius: 5px;
    flex: 1;
  }
  .buttonWrapper {
    display: inline-block;
    cursor: pointer;
    user-select: none; /* 選択を禁止する */
  }
  button {
    padding: 6px 12px;
    font-weight: bold;
    cursor: pointer;
    border: slategray 1px solid;
    border-radius: 5px;
    user-select: none; /* 選択を禁止する */
  }
  button:active {
    background-color: #DDD;
  }
  button.active {
    box-shadow: inset 0 2px 5px black;
  }
</style>

<body>
  <h1>SerialWeb</h1>
  <div id='tabBar'>
    <div id='dashboardTab' onclick='changeTab(this.id)'>Dashboard</div>
    <div id='logTab' onclick='changeTab(this.id)'>Log</div>
  </div>
  <div id='dashboardWrapper' class='content'></div>
  <div id='logWrapper' class='content'>
    <div id='logWindow'></div>
    <div id='statusWrapper'>Status: <span id='status'></span></div>
    <div class = 'buttonWrapper'>
      <button id='connectButton'>Connect</button>
    <button id='pauseButton'>Pause</button>
    <button id='clearButton'>Clear</button>
    </div>
    <div class = 'buttonWrapper'>
      <input type='checkbox' id='autoScroll' checked></input><label for='autoScroll'> Auto Scroll</label>
      <input type='checkbox' id='logTimestamps' checked></input><label for='logTimestamps'> Show Timestamps</label><br>
    </div>
    <form id='logForm'>
      <input type='text' id='logInput' placeholder='Type a message...' />
      <button id='logSendButton'>Send</button>
    </form>
  </div>

  <script src='demo.js' type='text/javascript'></script>
  <script type='text/javascript'>
    let ws; // グローバル変数として websocket を保持
    const status = document.getElementById('status'); // ステータスを表示するdiv要素
    const connectButton = document.getElementById('connectButton'); // 

    function initWebSocket() { // WebSocket接続の初期化（または再接続）
      addLog('Attempting to connect WebSocket...');
      ws = new WebSocket(`ws://${location.hostname}/ws`);// ポート80はHTTPのデフォルトなので、:80 は省略可能
      status.textContent = 'Connecting...';
      status.style.color = 'black';

      ws.onopen = () => { // 接続成功時の処理
        addLog('WebSocket connected');
        status.textContent = 'Connected';
        status.style.color = 'green';
        connectButton.textContent = 'Disconnect';
      };

      ws.onclose = () => { // 切断時の処理
        addLog('WebSocket disconnected.');
        status.textContent = 'Disconnected';
        status.style.color = 'darkorange';
        connectButton.textContent = 'Connect';
      };

      ws.onmessage = (event) => { // メッセージ受信時の処理
        addLog(`Received: ${event.data}`);
        // jsonデータのパース
        const data = JSON.parse(event.data);
        updateDashbordItem(data.index, data.label, data.value);
      };

      ws.onerror = (event) => {
        console.error('WebSocket Error: ', event);
        // エラー時も onclose が呼ばれることが多いので、再接続は onclose に任せる
        status.textContent = 'Error';
        status.style.color = 'red';
      };
    }

    // ページが読み込まれたら、最初の接続を開始する
    window.addEventListener('load', initWebSocket);

    connectButton.addEventListener('click', () => {
      if (status.textContent === 'Disconnected') {
        initWebSocket();
      }
      else {
        ws.close(1000, 'User requested disconnect');
      }
    });

    // タブの切り替え処理
    function changeTab(selectedTabId) {
      //console.log(`Changing to tab: ${selectedTab.id}`);
      const dashboardWrapper = document.getElementById('dashboardWrapper'); // ダッシュボード要素を取得
      //console.log(dashboardWrapper);
      const logWrapper = document.getElementById('logWrapper'); // ログラッパー要素を取得
      //console.log(logWrapper);
      const tabs = document.getElementById('tabBar').children; // タブバーの子要素を取得
      for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active'); // 子クラスからクラスを消去
      }
      document.getElementById(selectedTabId).classList.add('active'); // 選択されたタブにクラスを付与
      if (selectedTabId === 'dashboardTab') {
        dashboardWrapper.style.display = 'flex'; // ダッシュボードを表示
        logWrapper.style.display = 'none'; // ログラッパーを非表示
      } else if (selectedTabId === 'logTab') {
        dashboardWrapper.style.display = 'none'; // ダッシュボードを非表示
        logWrapper.style.display = 'block'; // ログラッパーを表示
      }
    }
    changeTab('dashboardTab'); // 初期表示はダッシュボードタブ

    // ログ一時停止ボタンのイベントリスナー設定
    let paused = false; // 一時停止状態を示すフラグ
    const pauseButton = document.getElementById('pauseButton');
    pauseButton.addEventListener('click', () => { // 一時停止ボタンのクリックイベントリスナーを設定
      const pauseLog = document.getElementById('pauseLog');
      paused = !paused; // 一時停止状態をトグル
      pauseButton.classList.toggle('active'); // クラスの付与状態をトグル
    });

    // ログ消去ボタンのイベントリスナー設定
    const clearButton = document.getElementById('clearButton');
    clearButton.addEventListener('click', () => { // クリアボタンのクリックイベントリスナーを設定
      const logWindow = document.getElementById('logWindow'); // ログウィンドウ要素を取得
      logWindow.innerHTML = ''; // ログウィンドウの内容をクリア
    });

    // オートスクロールのチェックボックスのイベントリスナーを設定
    const autoScroll = document.getElementById('autoScroll');
    autoScroll.addEventListener('change', () => { // オートスクロールのチェックボックスが変更されたときの処理
      const logWindow = document.getElementById('logWindow'); // ログウィンドウ要素を取得
      if (autoScroll.checked) {
        logWindow.scrollTop = logWindow.scrollHeight; // オートスクロールが有効なら、スクロール位置を最下部に設定
      }
    });

    // タイムスタンプのチェックボックスのイベントリスナーを設定
    const logTimestamps = document.getElementById('logTimestamps'); // タイムスタンプの要素を取得
    logTimestamps.addEventListener('change', () => {
      const timestamps = document.querySelectorAll('.timestamp'); // timestampクラスを取得
      timestamps.forEach(element => {
        if (logTimestamps.checked) {
          element.style.display = 'inline'; // 表示
        }
        else {
          element.style.display = 'none'; // 非表示
        }
      });
    });

    // ログを表示するヘルパー関数
    const MAX_LOG_ENTRIES = 500;
    function addLog(message) {
      if (paused) return; // 一時停止が有効ならreturn

      const logWindow = document.getElementById('logWindow'); // ログウィンドウ要素を取得

      const now = new Date();
      const timestamp = document.createElement('span');
      timestamp.textContent = `[${now.toLocaleTimeString()}:${now.getMilliseconds().toString().padStart(3, '0')}] `;
      timestamp.classList.add('timestamp');
      if (!logTimestamps.checked) {
        timestamp.style.display = 'none';
      }

      const messageSpan = document.createElement('span');
      messageSpan.textContent = message; // ログメッセージを設定
      
      const logEntry = document.createElement('div'); // 新しいdiv要素を作成
      logEntry.appendChild(timestamp); // ログメッセージにタイムスタンプを追加
      logEntry.appendChild(messageSpan);
      logWindow.appendChild(logEntry); // ログウィンドウにログエントリを追加

      if (autoScroll.checked) {
        logWindow.scrollTop = logWindow.scrollHeight; // オートスクロールが有効なら、スクロール位置を最下部に設定
      }
      while (logWindow.children.length > MAX_LOG_ENTRIES) { // ログの数がMAX_LOG_ENTRIES未満になるまで繰り返し
        logWindow.removeChild(logWindow.firstChild); // 最初の（一番古い）ログを消去
      }
    }

    // ダッシュボードアイテムを更新する関数
    function updateDashbordItem(index, label, value) {
      if (paused) return; // ログ一時停止が有効ならreturn

      if (document.getElementById(index) === null) {
        const dashboardWrapper = document.getElementById('dashboardWrapper'); // ダッシュボード要素を取得
        const itemDiv = document.createElement('div'); // 新しいdiv要素を作成
        itemDiv.id = index; // 数値のみのIDを付与

        const labelDiv = document.createElement('div'); // ラベル用のdiv要素を作成
        labelDiv.classList.add('label'); // labelクラスに追加
        labelDiv.id = `label${index}`; // label+数値のIDを付与

        const valueDiv = document.createElement('div'); // 値用のdiv要素を作成
        valueDiv.classList.add('value'); // valueクラスに追加
        valueDiv.id = `value${index}`; // value+数値のIDを付与

        itemDiv.appendChild(labelDiv); // ラベルdivをアイテムdivに追加
        itemDiv.appendChild(valueDiv); // 値divをアイテムdivに追加
        dashboardWrapper.appendChild(itemDiv); // アイテムdivをダッシュボードに追加
      }

      const itemDiv = document.getElementById(index);
      itemDiv.classList.add('update');
      setTimeout(() => {
        itemDiv.classList.remove('update');
      }, 200);
      const labelDiv = document.getElementById(`label${index}`);
      const valueDiv = document.getElementById(`value${index}`);
      labelDiv.textContent = label; // ラベルテキストを設定
      valueDiv.textContent = value; // 値テキストを設定
    }
    
    // ログ送信フォームのイベントリスナー設定
    const logForm = document.getElementById('logForm');
    logForm.addEventListener('submit', function(event) {
      event.preventDefault(); // フォームのデフォルトの送信動作を防止
      const logInput = document.getElementById('logInput'); // ログ入力要素を取得
      const message = logInput.value.trim(); // 入力値を取得してトリム
      if (message !== '') {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(message); // WebSocketが接続されていればメッセージを送信
          addLog(`Sent: ${message}`); // 送信ログを追加
          logInput.value = ''; // 入力フィールドをクリア
        } else {
          addLog('WebSocket is not connected. Cannot send message.'); // 接続されていない場合のログを追加
        }
      }
    });
  </script>
</body>
</html>
